<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>DevMate Agent</title>
    <style>
        body {
            font-family: Arial;
            max-width: 900px;
            margin: auto;
        }

        .box {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }

        .planning {
            background: #eef;
        }

        .tool {
            background: #ffe;
        }

        .llm {
            background: #efe;
        }

        .label {
            font-weight: bold;
        }
    </style>
</head>

<body>

    <h2>DevMate ðŸ¤–</h2>

    <input id="input" style="width:80%" placeholder="è¾“å…¥ä½ çš„éœ€æ±‚..." value="å¤©æ°”"/>
    <button onclick="send()">Send</button>

    <div id="planning" class="box planning">
        <div class="label">ðŸ§  Planning</div>
    </div>

    <div id="tools" class="box tool">
        <div class="label">ðŸ”§ Tool Calls</div>
    </div>

    <div id="llm" class="box llm">
        <div class="label">ðŸ’¬ LLM Output</div>
    </div>

    <script>
        document.getElementById("planning").innerHTML = "<div class='label'>ðŸ§  Planning</div>";
        document.getElementById("tools").innerHTML = "<div class='label'>ðŸ”§ Tool Calls</div>";
        document.getElementById("llm").innerHTML = "<div class='label'>ðŸ’¬ LLM Output</div>";

        let sending = false;

        function send() {
            if (sending) return;
            sending = true;

            const input = document.getElementById("input").value;

            // æ¯æ¬¡ç‚¹å‡»éƒ½æ–°å»ºä¸€ä¸ª WebSocket
            const ws = new WebSocket("ws://localhost:8008/chat/program");

            ws.onopen = () => {
                console.log("âœ… WebSocket connected");
                ws.send(JSON.stringify({ action: "start", user_input: input }));
            };

            ws.onmessage = (event) => {
                const lines = event.data.split("\n");
                let type = "", data = "";

                for (let line of lines) {
                    if (line.startsWith("event:")) type = line.replace("event:", "").trim();
                    if (line.startsWith("data:")) data += line.replace("data:", "");
                }

                if (type === "planning") {
                    document.getElementById("planning").innerHTML += `<p>${data}</p>`;
                }
                if (type === "tool_call" || type === "tool_result") {
                    document.getElementById("tools").innerHTML += `<p>${data}</p>`;
                }
                if (type === "llm") {
                    document.getElementById("llm").innerHTML += data;
                }
            };

            ws.onerror = (err) => {
                console.error("âŒ WebSocket error", err);
                sending = false;
            };

            ws.onclose = () => {
                console.log("ðŸ”š WebSocket closed");
                sending = false;
            };
        }
    </script>

</body>

</html>